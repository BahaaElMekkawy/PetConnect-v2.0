<div *ngIf="blogPost" class="container py-5 min-vh-100">
  <div class="row justify-content-center" style="min-height: 100vh">
    <div class="col-lg-8">
      <div *ngIf="loading" class="text-center my-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2">Loading blogs...</p>
      </div>
      <!-- Header -->
      <div class="mb-3 p-4 bg-light rounded shadow-sm">
        <div class="my-2">
          <ng-container *ngIf="blogPost.categoryName">
            <a [routerLink]="['/blog/category', blogPost.categoryName]">
              <span class="badge border text-secondary small text-wrap">
                {{ blogPost.categoryName }}
              </span>
            </a>
          </ng-container>

          <ng-container *ngIf="blogPost.categoryName && blogPost.topic">
            <span class="mx-1"></span>
          </ng-container>

          <ng-container *ngIf="blogPost.topic">
            <a [routerLink]="['/blog/topic', blogPost.topic]">
              <span class="badge border text-secondary small text-wrap">
                {{ blogPost.topic }}
              </span></a>
          </ng-container>
        </div>
        <!-- Added text-break class for proper title wrapping -->
        <h1 class="fw-bold mb-3 text-break">{{ blogPost.title }}</h1>

        <div class="d-flex align-items-center flex-wrap text-muted">
          <a [routerLink]="['/doctors', blogPost.doctorId]" class="d-flex align-items-center text-decoration-none me-3 mb-2">
            <img [src]="getFullImageUrl(blogPost.doctorImgUrl)" alt="Doctor" class="rounded-circle me-2 border flex-shrink-0"
              style="width: 40px; height: 40px; object-fit: cover" />
            <!-- Added text-break for doctor name wrapping -->
            <span class="fw-semibold text-dark text-break">Dr. {{ blogPost.doctorName }}</span>
          </a>
          <span class="mb-2">{{ blogPost.postDate | date : "mediumDate" }}</span>
        </div>
      </div>

      <!-- Media -->
      <div *ngIf="blogPost.media" class="mb-4">
        <img [src]="getFullImageUrl(blogPost.media)" alt="Blog Media" class="img-fluid rounded shadow mb-5 w-100"
          style="max-height: 400px; object-fit: cover" />
      </div>

      <!-- Content -->
      <!-- Enhanced content container with better overflow handling -->
      <div class="blog-content-container mb-5 fs-5 lh-lg" [innerHTML]="blogPost.content"></div>

      <!-- Likes -->
      <div class="d-flex align-items-center my-4 flex-wrap gap-2">
        <button class="like-btn flex-shrink-0" [class.active]="blogPost.isLikedByUser" (click)="likePost(blogPost.id)" *ngIf="isAuth">
          <i class="fas fa-thumbs-up me-2"></i>
          <span>{{ blogPost.isLikedByUser ? "Liked" : "Like" }}</span>
        </button>
        <span class="flex-shrink-0">{{ blogPost.likes }} likes</span>
      </div>

      <hr />

      <!-- Comments Section -->
      <h5 class="mb-3">Comments ({{ comments?.length || 0 }})</h5>

      <!-- Comments List -->
      <div *ngFor="let comment of comments" class="text-start">
        <div class="mb-3 p-3 border rounded position-relative comment-card">
          <!-- Delete icon for comment -->
          <i *ngIf="comment.posterId === userId" class="fas fa-close text-secondary position-absolute delete-icon"
            style="top: 8px; right: 8px; cursor: pointer" (click)="deleteComment(comment.id)"></i>
          <div class="d-flex align-items-start mb-2">
            <img [src]="getFullImageUrl(comment.posterImage)" class="rounded-circle me-2 flex-shrink-0" alt="User" width="40"
              height="40" />
            <div class="flex-grow-1 min-w-0">
              <!-- Added text-break for username wrapping -->
              <strong class="text-break">{{ comment.posterName }}</strong>
            </div>
          </div>
          <ng-container *ngIf="comment.media && attachmentService.isImage(comment.media)">
            <img [src]="getFullImageUrl(comment.media)" alt="Comment Media" class="img-fluid rounded mb-2 comment-image"
              style="max-width: 200px; max-height: 200px; object-fit: cover" />
          </ng-container>
          <!-- Added text-break for comment content wrapping -->
          <p class="mb-2 text-break">{{ comment.comment }}</p>

          <!-- Like button -->
          <div class="mb-2 d-flex align-items-center flex-wrap gap-2">
            <button class="like-btn py-1 px-2 flex-shrink-0" [class.active]="comment.isLikedByUser"
              (click)="likeComment(comment.id)" *ngIf="isAuth">
              <i class="fas fa-thumbs-up me-1 small"></i>
              <span class="small">
                {{ comment.isLikedByUser ? "Liked" : "Like" }}
              </span>
            </button>
            <span class="flex-shrink-0 px-2 small">{{ comment.numberOfLikes }} likes</span>
            <button class="btn btn-sm flex-shrink-0" (click)="loadReplies(comment.id)">
              {{ comment.numberOfReplies }} Replies
            </button>
          </div>
        </div>

        <!-- Replies section -->
        <div *ngIf="comment.showReplies" class="ms-3 ms-md-5 mt-2 mb-4">
          <div *ngIf="comment.replies.length > 0; else noReplies">
            <div *ngFor="let reply of comment.replies" class="border p-2 mb-2 rounded position-relative reply-card">
              <!-- Delete icon for reply -->
              <i *ngIf="comment.posterId === userId" class="fas fa-close text-black-50 position-absolute delete-icon"
                style="top: 8px; right: 8px; cursor: pointer" (click)="deleteReply(comment.id, reply.id)"></i>
              <div class="d-flex align-items-start mb-1">
                <img [src]="getFullImageUrl(reply.posterImage)" class="rounded-circle me-2 flex-shrink-0" alt="User" width="30"
                  height="30" />
                <!-- Added text-break for reply username wrapping -->
                <strong class="text-break">{{ reply.posterName }}</strong>
              </div>
              <!-- Added text-break for reply content wrapping -->
              <p class="my-1 text-break">{{ reply.reply }}</p>
              <div class="d-flex align-items-center flex-wrap gap-2">
                <button class="like-btn btn-sm flex-shrink-0" [class.active]="reply.isLikedByUser"
                  (click)="likeReply(reply.id, comment.id)" *ngIf="isAuth">
                  <i class="fas fa-thumbs-up me-1 small"></i>
                  <span class="small">{{
                    reply.isLikedByUser ? "Liked" : "Like"
                    }}</span>
                </button>
                <span class="small flex-shrink-0">{{ reply.numberOfLikes || 0 }} likes</span>
              </div>
            </div>
          </div>
          <ng-template #noReplies>
            <p class="text-muted small">No replies yet.</p>
          </ng-template>

          <!-- Reply input -->
          <div class="d-flex mt-2 gap-2" *ngIf="isAuth">
            <input type="text" [(ngModel)]="newReply.reply" placeholder="Write a reply..." class="form-control flex-grow-1" />
            <button class="btn btn-primary btn-sm flex-shrink-0" (click)="addReply(comment.id)">
              Reply
            </button>
          </div>
        </div>
      </div>

      <!-- Image Preview -->
      <div *ngIf="imagePreview" class="position-relative d-inline-block mt-2">
        <img [src]="imagePreview" alt="Preview" class="img-fluid" style="max-height: 100px; border-radius: 8px" />
        <button type="button" class="btn btn-sm btn-danger position-absolute remove-image-btn" style="
            top: 0;
            right: 0;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 14px;
            padding: 0;
          " (click)="clearImage()" aria-label="Remove image" title="Remove image">
          &times;
        </button>
      </div>

      <!-- Comment Form -->
      <div class="comment-box d-flex align-items-center gap-2 mt-2 flex-wrap" *ngIf="isAuth">
        <!-- Comment Input -->
        <input type="text" class="form-control flex-grow-1" placeholder="Write a comment..." [(ngModel)]="newComment.comment" />

        <!-- File Upload Icon -->
        <label for="fileUpload" class="btn btn-light p-2 rounded-circle flex-shrink-0" style="cursor: pointer">
          <i class="bi bi-paperclip"></i>
        </label>
        <input type="file" id="fileUpload" accept="image/*" (change)="onFileSelected($event)" style="display: none" />

        <!-- Submit Button -->
        <button class="btn btn-primary flex-shrink-0" (click)="addComment()">
          <i class="bi bi-send"></i>
        </button>
      </div>

      <span class="text-muted flex-sm-shrink-0" *ngIf="!isAuth">Login to comment, like and reply</span>
    </div>
  </div>
</div>
